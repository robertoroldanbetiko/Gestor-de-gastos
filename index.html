<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#030508">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlador de Gastos Maestro V12.9 - TimeCalc Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #030508; --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.1);
            --green: #00ffaa; --red: #ff3366; --cyan: #00e5ff; --purple: #bc13fe; --orange: #ff9500; --text: #ffffff;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .tabs { display: flex; background: #000; position: sticky; top: 0; z-index: 900; border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; color: #555; font-weight: 800; cursor: pointer; font-size: 0.7rem; letter-spacing: 1px; }
        .tab-btn.active { color: var(--purple); border-bottom: 3px solid var(--purple); background: linear-gradient(to top, rgba(188,19,254,0.05), transparent); }
        .container { max-width: 900px; margin: auto; padding: 15px; padding-bottom: 120px; }
        .view { display: none; }
        .view.active { display: block; }
        .header-section { text-align: center; padding: 25px 0 15px 0; position: relative; }
        .btn-privacy { position: absolute; right: 10px; top: 25px; background: none; border: 1px solid var(--border); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-privacy.active { border-color: var(--cyan); box-shadow: 0 0 10px var(--cyan); }
        .btn-privacy svg { fill: #555; width: 20px; }
        .btn-privacy.active svg { fill: var(--cyan); }
        .global-label { font-size: 0.75rem; color: #555; letter-spacing: 3px; font-weight: 900; text-transform: uppercase; margin-bottom: 5px; }
        .total-label { font-size: clamp(2.8rem, 10vw, 4rem); font-weight: 900; margin: 0; line-height: 1; letter-spacing: -1px; }
        .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .cat-node { background: var(--glass); padding: 18px 10px; border-radius: 20px; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100px; border-width: 2px; border-style: solid; }
        .border-safe { border-color: var(--green); }
        .border-warning { border-color: var(--orange); }
        .border-danger { border-color: var(--red); }
        .cat-name { font-weight: 800; font-size: 0.8rem; color: #888; margin-bottom: 8px; text-transform: uppercase; }
        .cat-amount { font-size: 1.25rem; font-weight: 900; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(255,255,255,0.04); margin-bottom: 8px; border-radius: 18px; border: 1px solid var(--border); gap: 10px; }
        .item-info { flex: 1; min-width: 0; }
        .item-info strong { display: block; font-size: 0.95rem; color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .btn-icon { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 10px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .tag-pill { background: rgba(0, 229, 255, 0.1); color: var(--cyan); padding: 2px 8px; border-radius: 6px; font-size: 0.65rem; font-weight: bold; margin-right: 4px; text-transform: uppercase; display: inline-block; margin-top: 4px; cursor: pointer; }
        .tag-pill.active { background: var(--cyan); color: #000; }
        .tag-summary { background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 10px; border-radius: 12px; margin-bottom: 15px; font-size: 0.8rem; }
        
        /* Widget Flotante */
        .time-widget { position: fixed; bottom: 25px; left: 20px; width: 140px; background: #000; border: 1px solid var(--orange); border-radius: 20px; padding: 12px; z-index: 1000; box-shadow: 0 10px 30px rgba(255,149,0,0.2); }
        .time-widget input { font-size: 0.8rem; padding: 8px; margin-bottom: 8px; border-color: #333; }
        .time-result { font-size: 0.7rem; color: var(--orange); font-weight: bold; text-align: center; }

        .fab-container { position: fixed; bottom: 25px; right: 25px; display: flex; flex-direction: column; gap: 12px; z-index: 999; }
        .fab { width: 55px; height: 55px; background: #000; border-radius: 18px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--cyan); cursor: pointer; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1001; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-content { background: #0a0f18; padding: 25px; border-radius: 25px; border: 1px solid var(--border); width: 85%; max-width: 350px; }
        .glass-card { background: var(--glass); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 20px; }
        input, select { background: #0f141e; color: #fff; border: 1px solid var(--border); padding: 12px; border-radius: 12px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .btn-primary { background: var(--purple); color: #fff; border: none; padding: 14px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; }
        .btn-outline { background: none; border: 1px solid var(--border); color: #fff; padding: 12px; border-radius: 12px; width: 100%; cursor: pointer; }
        #detailView { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 1000; padding: 15px; overflow-y: auto; }
        .tag-dropdown { position: absolute; background: #0a0f18; border: 1px solid var(--border); border-radius: 12px; z-index: 100; max-height: 150px; overflow-y: auto; display: none; width: 80%; }
        .tag-option { padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; }
    </style>
</head>
<body>

<div class="time-widget" id="timeWidget">
    <div style="font-size: 0.6rem; color: #888; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px;">Calculadora Trabajo</div>
    <input type="number" id="widgetPrice" placeholder="Precio €" oninput="calculateWidget()">
    <div id="widgetOutput" class="time-result">0.0h trabajo</div>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('cats', this)">CATEGORÍAS</button>
    <button class="tab-btn" onclick="switchTab('stats', this)">ESTADÍSTICAS</button>
    <button class="tab-btn" onclick="switchTab('settings', this)">AJUSTES</button>
</div>

<div class="container">
    <div class="header-section">
        <button id="privacyBtn" class="btn-privacy" onclick="togglePrivacy()">
            <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
        </button>
        <div class="global-label">Balance Global</div>
        <div id="masterTotal" class="total-label">0.00€</div>
    </div>

    <div id="catsView" class="view active"><div id="menuContainer" class="cat-grid"></div></div>
    
    <div id="statsView" class="view">
        <div class="glass-card">
            <h3 style="text-align:center; margin-top:0;">Tendencia de Gastos</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <select id="statMonthSelector" onchange="renderStats()"></select>
                <select id="statCatSelector" onchange="renderStats()">
                    <option value="global">Global (Todo)</option>
                </select>
            </div>
            <div style="height:220px; margin-bottom:25px;"><canvas id="lineChart"></canvas></div>
            <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
            <div style="height:180px;"><canvas id="statsChart"></canvas></div>
            <div id="statsPeriodTotal" class="total-label" style="font-size: 2.2rem; text-align:center; margin-top:15px;">0.00€</div>
        </div>
    </div>

    <div id="settingsView" class="view">
        <div class="glass-card">
            <h3>Configuración Laboral</h3>
            <p style="font-size:0.8rem; color:#888;">Introduce cuánto ganas por hora neta.</p>
            <input type="number" id="hourlyRate" placeholder="€ / Hora Neta" onchange="saveHourlyRate()">
        </div>
        <div class="glass-card">
            <h3>Copia de Seguridad</h3>
            <button class="btn-primary" onclick="exportData()">EXPORTAR JSON</button>
            <input type="file" id="importFile" accept=".json" style="margin-top:20px">
            <button class="btn-outline" onclick="importData()">IMPORTAR JSON</button>
        </div>
    </div>
</div>

<div class="fab-container">
    <div class="fab" style="border-color:var(--red); height:45px; width:45px; align-self:center;" onclick="showDelModal()">✖</div>
    <div class="fab" onclick="showAddModal()">➕</div>
</div>

<div id="detailView">
    <div class="container">
        <button class="btn-outline" style="width:auto; margin-bottom:15px; border-color:#333;" onclick="closeDetail()">← VOLVER</button>
        <div class="glass-card" id="detailHeaderCard">
            <h1 id="detTitle" style="margin:0; font-size:1.1rem; color:var(--cyan); text-transform:uppercase;"></h1>
            <div id="detTotal" class="total-label" style="text-align:left; font-size:2.5rem; margin-top:5px;">0.00€</div>
        </div>
        <div id="tagSummary" class="tag-summary"></div>
        <div class="glass-card">
            <input type="hidden" id="editIdx" value="-1">
            <input type="text" id="itemDesc" placeholder="Concepto">
            <input type="number" id="itemAmt" placeholder="Importe €">
            <input type="text" id="itemTags" placeholder="Etiquetas" onfocus="toggleTagDropdown(true)" onblur="setTimeout(()=>toggleTagDropdown(false), 200)">
            <div id="tagDropdown" class="tag-dropdown"></div>
            <input type="date" id="itemDate">
            <select id="itemType"><option value="ingreso">Ingreso (+)</option><option value="gasto" selected>Gasto (-)</option></select>
            <button class="btn-primary" id="saveBtn" style="background:var(--cyan); color:#000;" onclick="addItem()">GUARDAR</button>
        </div>
        <div id="itemsList"></div>
    </div>
</div>

<div id="addModal" class="modal"><div class="modal-content"><h3>Nueva Categoría</h3><input type="text" id="newCatName"><button class="btn-primary" onclick="addCategory()">CREAR</button><button class="btn-outline" onclick="hideModals()" style="margin-top:10px">CERRAR</button></div></div>
<div id="delModal" class="modal"><div class="modal-content"><h3>Eliminar Categoría</h3><div id="delList"></div><button class="btn-outline" onclick="hideModals()" style="margin-top:10px">VOLVER</button></div></div>

<script>
    let data = JSON.parse(localStorage.getItem('finanzas_v12')) || {};
    let activeCat = null, sChart = null, lChart = null, isPrivacy = false, activeFilter = null;

    const ICON_EDIT = `<svg viewBox="0 0 24 24" fill="var(--cyan)"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg>`;
    const ICON_DEL = `<svg viewBox="0 0 24 24" fill="var(--red)"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;

    function save() { localStorage.setItem('finanzas_v12', JSON.stringify(data)); renderAll(); }
    function togglePrivacy() { isPrivacy = !isPrivacy; document.getElementById('privacyBtn').classList.toggle('active'); renderAll(); if(activeCat) renderItems(); }
    function formatAmt(n) { return isPrivacy ? "****€" : `${n.toFixed(2)}€`; }

    // Logica del Widget de Tiempo
    function saveHourlyRate() { 
        localStorage.setItem('hourlyRate', document.getElementById('hourlyRate').value); 
        calculateWidget();
        if(activeCat) renderItems(); 
    }
    
    function calculateWidget() {
        const rate = parseFloat(localStorage.getItem('hourlyRate')) || 0;
        const price = parseFloat(document.getElementById('widgetPrice').value) || 0;
        const output = document.getElementById('widgetOutput');
        if(rate > 0 && price > 0) {
            output.innerText = (price / rate).toFixed(1) + "h de trabajo";
        } else {
            output.innerText = "0.0h trabajo";
        }
    }

    function renderAll() {
        const cont = document.getElementById('menuContainer'); cont.innerHTML = ''; let global = 0;
        const selCat = document.getElementById('statCatSelector');
        const currentVal = selCat.value;
        selCat.innerHTML = '<option value="global">Global (Todo)</option>';
        for(let cat in data) {
            let sum = data[cat].reduce((a,b) => a + b.amount, 0); global += sum;
            let b = sum > 100 ? 'border-safe' : (sum >= 0 ? 'border-warning' : 'border-danger');
            cont.innerHTML += `<div class="cat-node ${b}" onclick="openDetail('${cat}')"><span class="cat-name">${cat}</span><span class="cat-amount" style="color:${sum>=0?'var(--green)':'var(--red)'}">${formatAmt(sum)}</span></div>`;
            selCat.add(new Option(cat.toUpperCase(), cat));
        }
        selCat.value = currentVal;
        document.getElementById('masterTotal').innerText = formatAmt(global);
        document.getElementById('masterTotal').style.color = global >= 0 ? 'var(--green)' : 'var(--red)';
    }

    function openDetail(cat) { activeCat = cat; activeFilter = null; document.getElementById('detailView').style.display='block'; document.getElementById('detTitle').innerText=cat; renderItems(); updateTagDropdown(); }
    function closeDetail() { document.getElementById('detailView').style.display='none'; activeCat=null; renderAll(); }

    function updateTagDropdown() {
        const dropdown = document.getElementById('tagDropdown'); const tags = new Set();
        data[activeCat].forEach(item => { if(item.tags) item.tags.split(',').forEach(t => tags.add(t.trim().toLowerCase())); });
        dropdown.innerHTML = Array.from(tags).map(t => `<div class="tag-option" onclick="selectTag('${t}')">${t.toUpperCase()}</div>`).join('');
    }
    function toggleTagDropdown(show) { document.getElementById('tagDropdown').style.display = show ? 'block' : 'none'; }
    function selectTag(tag) { const input = document.getElementById('itemTags'); let current = input.value.split(',').map(t => t.trim()).filter(t => t); if(!current.includes(tag)) current.push(tag); input.value = current.join(', '); toggleTagDropdown(false); }

    function filterByTag(tag) { activeFilter = (activeFilter === tag) ? null : tag; renderItems(); }

    function renderItems() {
        const list = document.getElementById('itemsList'); list.innerHTML = ''; let sum = 0, tagMap = {};
        const hourlyRate = parseFloat(localStorage.getItem('hourlyRate')) || 0;
        const filteredData = activeFilter ? data[activeCat].filter(item => item.tags && item.tags.toLowerCase().includes(activeFilter.toLowerCase())) : data[activeCat];
        data[activeCat].forEach((item) => { if(item.tags) item.tags.split(',').forEach(t => { let tag = t.trim().toLowerCase(); if(tag) tagMap[tag] = (tagMap[tag] || 0) + item.amount; }); });
        filteredData.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((item, i) => {
            sum += item.amount;
            let tagsHtml = (item.tags || '').split(',').map(t => t.trim() ? `<span class="tag-pill ${activeFilter === t.trim().toLowerCase() ? 'active' : ''}" onclick="filterByTag('${t.trim().toLowerCase()}')">${t.trim()}</span>` : '').join('');
            let hoursHtml = (item.amount < 0 && hourlyRate > 0) ? `<div style="font-size:0.7rem; color:var(--orange);">⏱ ${(Math.abs(item.amount)/hourlyRate).toFixed(1)}h</div>` : "";
            list.innerHTML += `<div class="list-item"><div class="item-info"><small>${item.date}</small><strong>${item.desc}</strong><div>${tagsHtml}</div></div><div class="item-right" style="flex-direction:column; align-items:flex-end;"><span style="color:${item.amount>=0?'var(--green)':'var(--red)'}; font-weight:900;">${formatAmt(item.amount)}</span>${hoursHtml}<div style="display:flex; gap:5px; margin-top:4px;"><button class="btn-icon" onclick="editItem(${i})">${ICON_EDIT}</button><button class="btn-icon" onclick="deleteItem(${i})">${ICON_DEL}</button></div></div></div>`;
        });
        let tagBox = document.getElementById('tagSummary');
        tagBox.innerHTML = `<strong>Sub-totales:</strong><br>`;
        for(let t in tagMap) tagBox.innerHTML += `<span class="tag-pill ${activeFilter === t ? 'active' : ''}" onclick="filterByTag('${t}')">${t.toUpperCase()}: ${formatAmt(tagMap[t])}</span>`;
        document.getElementById('detTotal').innerText = formatAmt(sum);
    }

    function addItem() {
        const d = document.getElementById('itemDesc').value, a = parseFloat(document.getElementById('itemAmt').value), dt = document.getElementById('itemDate').value, t = document.getElementById('itemType').value, tags = document.getElementById('itemTags').value, idx = parseInt(document.getElementById('editIdx').value);
        if(d && !isNaN(a) && dt) {
            const entry = { desc: d, amount: t === 'gasto' ? -Math.abs(a) : Math.abs(a), date: dt, tags: tags };
            if(idx === -1) data[activeCat].push(entry); else data[activeCat][idx] = entry;
            save(); renderItems(); resetForm(); updateTagDropdown();
        }
    }
    function editItem(i) { const it = data[activeCat][i]; document.getElementById('itemDesc').value = it.desc; document.getElementById('itemAmt').value = Math.abs(it.amount); document.getElementById('itemDate').value = it.date; document.getElementById('itemTags').value = it.tags || ''; document.getElementById('itemType').value = it.amount > 0 ? 'ingreso' : 'gasto'; document.getElementById('editIdx').value = i; }
    function deleteItem(i) { if(confirm('¿Eliminar concepto?')) { data[activeCat].splice(i,1); save(); renderItems(); } }
    function resetForm() { document.getElementById('editIdx').value="-1"; document.getElementById('itemDesc').value=""; document.getElementById('itemAmt').value=""; document.getElementById('itemTags').value=""; }
    function showAddModal() { document.getElementById('addModal').style.display='flex'; }
    function showDelModal() { const list = document.getElementById('delList'); list.innerHTML = ''; for(let cat in data) list.innerHTML += `<div class="list-item"><strong>${cat}</strong><button class="btn-icon" onclick="deleteCategory('${cat}')">${ICON_DEL}</button></div>`; document.getElementById('delModal').style.display='flex'; }
    function deleteCategory(cat) { if(confirm(`¿Eliminar ${cat}?`)) { delete data[cat]; save(); showDelModal(); } }
    function hideModals() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
    function addCategory() { const n = document.getElementById('newCatName').value.trim(); if(n && !data[n]) { data[n]=[]; hideModals(); save(); } }
    function switchTab(t, b) { document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active')); document.querySelectorAll('.view').forEach(x => x.classList.remove('active')); b.classList.add('active'); document.getElementById(t+'View').classList.add('active'); if(t==='stats') renderStats(); }

    function renderStats() {
        const period = document.getElementById('statMonthSelector').value;
        const catFilter = document.getElementById('statCatSelector').value;
        const isAnnual = period.length === 4;
        let inc = 0, exp = 0, timeLabels = [], timeData = [];
        if (isAnnual) {
            timeLabels = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
            timeData = new Array(12).fill(0);
        } else {
            const [y, m] = period.split('-');
            const daysInMonth = new Date(y, m, 0).getDate();
            timeLabels = Array.from({length: daysInMonth}, (_, i) => i + 1);
            timeData = new Array(daysInMonth).fill(0);
        }
        for (let c in data) {
            if (catFilter !== 'global' && c !== catFilter) continue;
            data[c].forEach(item => {
                if (item.date.startsWith(period)) {
                    const amount = Math.abs(item.amount);
                    if (item.amount > 0) inc += amount; else exp += amount;
                    if (item.amount < 0) {
                        const d = new Date(item.date);
                        const idx = isAnnual ? d.getMonth() : d.getDate() - 1;
                        if(timeData[idx] !== undefined) timeData[idx] += amount;
                    }
                }
            });
        }
        const ctxL = document.getElementById('lineChart').getContext('2d');
        if (lChart) lChart.destroy();
        lChart = new Chart(ctxL, { type: 'line', data: { labels: timeLabels, datasets: [{ data: timeData, borderColor: '#bc13fe', backgroundColor: 'rgba(188, 19, 254, 0.1)', fill: true, tension: 0.4, borderWidth: 3, pointRadius: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#222' }, ticks: { color: '#555', font: { size: 10 } } }, x: { grid: { display: false }, ticks: { color: '#555', font: { size: 10 } } } } } });
        document.getElementById('statsPeriodTotal').innerText = formatAmt(inc - exp);
        const ctxD = document.getElementById('statsChart').getContext('2d');
        if (sChart) sChart.destroy();
        sChart = new Chart(ctxD, { type: 'doughnut', data: { labels: ['Ingresos', 'Gastos'], datasets: [{ data: (inc + exp) > 0 ? [inc, exp] : [1, 0.01], backgroundColor: ['#00ffaa', '#ff3366'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom', labels: { color: '#888' } } } } });
    }

    // Inicialización de selectores y carga de datos
    const selM = document.getElementById('statMonthSelector');
    const now = new Date();
    for (let y = now.getFullYear() - 1; y <= now.getFullYear(); y++) {
        selM.add(new Option(`AÑO COMPLETO ${y}`, `${y}`));
        for (let m = 1; m <= 12; m++) {
            let v = `${y}-${m.toString().padStart(2, '0')}`;
            selM.add(new Option(v, v));
            if (v === `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`) selM.value = v;
        }
    }

    window.onload = () => { 
        const savedRate = localStorage.getItem('hourlyRate'); 
        if (savedRate) {
            document.getElementById('hourlyRate').value = savedRate;
            calculateWidget();
        }
        renderAll();
    }

    function exportData() { const b = new Blob([JSON.stringify(data)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `backup.json`; a.click(); }
    function importData() { const f = document.getElementById('importFile').files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { try { data = JSON.parse(e.target.result); save(); location.reload(); } catch (err) { alert("Error JSON"); } }; r.readAsText(f); }

    renderAll();
</script>
</body>
</html>
